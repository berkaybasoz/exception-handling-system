<!DOCTYPE html>
<html lang="tr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exceptions - Exception Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-bug"></i> Exception Monitor
                <span class="badge bg-secondary ms-2" th:text="'v' + ${applicationVersion}">v1.0.0</span>
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link active" href="/exceptions">Exceptions</a>
                <a class="nav-link" href="/components">Components</a>
                <a class="nav-link" href="/projects">Projects</a>
                <a class="nav-link" href="/environments">Environments</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Time Range Selector -->
        <div class="row mb-3">
            <div class="col-12">
                <form id="timeRangeForm" method="get" action="/exceptions">
                    <input type="hidden" id="selectedTimeRange" name="timeRange" th:value="${selectedTimeRange}">
                    <input type="hidden" id="customStartDateInput" name="customStartDate">
                    <input type="hidden" id="customEndDateInput" name="customEndDate">
                    <input type="hidden" name="projectName" th:value="${projectName}">
                    <input type="hidden" name="exceptionType" th:value="${exceptionType}">
                    <input type="hidden" name="environment" th:value="${environment}">
                    <input type="hidden" name="componentName" th:value="${componentName}">
                    <input type="hidden" name="serviceName" th:value="${serviceName}">
                    <input type="hidden" name="method" th:value="${method}">
                    <input type="hidden" name="advancedQuery" th:value="${advancedQuery}">
                    
                    <div class="d-flex justify-content-end align-items-center">
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-sm" th:classappend="${selectedTimeRange == '5m' ? 'btn-primary' : 'btn-outline-primary'}" onclick="selectTimeRange('5m')">5m</button>
                            <button type="button" class="btn btn-sm" th:classappend="${selectedTimeRange == '15m' ? 'btn-primary' : 'btn-outline-primary'}" onclick="selectTimeRange('15m')">15m</button>
                            <button type="button" class="btn btn-sm" th:classappend="${selectedTimeRange == '30m' ? 'btn-primary' : 'btn-outline-primary'}" onclick="selectTimeRange('30m')">30m</button>
                            <button type="button" class="btn btn-sm" th:classappend="${selectedTimeRange == '1h' ? 'btn-primary' : 'btn-outline-primary'}" onclick="selectTimeRange('1h')">1h</button>
                            <button type="button" class="btn btn-sm" th:classappend="${selectedTimeRange == '6h' ? 'btn-primary' : 'btn-outline-primary'}" onclick="selectTimeRange('6h')">6h</button>
                            <button type="button" class="btn btn-sm" th:classappend="${selectedTimeRange == '12h' ? 'btn-primary' : 'btn-outline-primary'}" onclick="selectTimeRange('12h')">12h</button>
                            <button type="button" class="btn btn-sm" th:classappend="${selectedTimeRange == '24h' or selectedTimeRange == '1d' ? 'btn-primary' : 'btn-outline-primary'}" onclick="selectTimeRange('1d')">1d</button>
                            <button type="button" class="btn btn-sm" th:classappend="${selectedTimeRange == '7d' ? 'btn-primary' : 'btn-outline-primary'}" onclick="selectTimeRange('7d')">7d</button>
                            <button type="button" class="btn btn-sm" th:classappend="${selectedTimeRange == '30d' ? 'btn-primary' : 'btn-outline-primary'}" onclick="selectTimeRange('30d')">30d</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#customDateModal">
                                <i class="fas fa-calendar"></i> Custom
                            </button>
                        </div>
                        
                        <button type="submit" class="btn btn-success btn-sm me-2">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                        
                        <div class="text-muted small">
                            <i class="fas fa-clock"></i>
                            <span th:if="${startDate != null and endDate != null}" 
                                  th:text="${#temporals.format(startDate, 'MM/dd HH:mm')} + ' - ' + ${#temporals.format(endDate, 'MM/dd HH:mm')}">
                                Date Range
                            </span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form method="get" action="/exceptions">
                    <div class="row">
                        <div class="col-md-2">
                            <label for="projectName" class="form-label">Project Name</label>
                            <select class="form-select" id="projectName" name="projectName">
                                <option value="">All</option>
                                <option th:each="project : ${distinctProjects}" 
                                        th:value="${project}" 
                                        th:text="${project}" 
                                        th:selected="${project == projectName}">Project</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="exceptionType" class="form-label">Exception Type</label>
                            <select class="form-select" id="exceptionType" name="exceptionType">
                                <option value="">All</option>
                                <option th:each="type : ${distinctExceptionTypes}" 
                                        th:value="${type}" 
                                        th:text="${type}" 
                                        th:selected="${type == exceptionType}">Exception Type</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="environment" class="form-label">Environment</label>
                            <select class="form-select" id="environment" name="environment">
                                <option value="">All</option>
                                <option th:each="env : ${distinctEnvironments}" 
                                        th:value="${env}" 
                                        th:text="${env}" 
                                        th:selected="${env == environment}">Environment</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="componentName" class="form-label">Component</label>
                            <select class="form-select" id="componentName" name="componentName">
                                <option value="">All</option>
                                <option th:each="component : ${distinctComponents}" 
                                        th:value="${component}" 
                                        th:text="${component}" 
                                        th:selected="${component == componentName}">Component</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="serviceName" class="form-label">Service Name</label>
                            <select class="form-select" id="serviceName" name="serviceName">
                                <option value="">All</option>
                                <option th:each="service : ${distinctServices}" 
                                        th:value="${service}" 
                                        th:text="${service}" 
                                        th:selected="${service == serviceName}">Service</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="method" class="form-label">Method</label>
                            <select class="form-select" id="method" name="method">
                                <option value="">All</option>
                                <option th:each="methodName : ${distinctMethods}" 
                                        th:value="${methodName}" 
                                        th:text="${methodName}" 
                                        th:selected="${methodName == method}">Method</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="advancedQuery" class="form-label">
                                Advanced Query 
                                <button type="button" class="btn btn-sm btn-link p-0 ms-2" data-bs-toggle="modal" data-bs-target="#queryHelpModal">
                                    <i class="fas fa-question-circle"></i> Help
                                </button>
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="advancedQuery" name="advancedQuery" 
                                       th:value="${advancedQuery}" 
                                       placeholder='e.g., headers.User-Agent:"Chrome" AND params.userId:123 OR additionalData.level:"ERROR"'
                                       style="font-family: monospace;">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-history"></i> Recent
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item query-example" href="#">headers.Authorization:"Bearer"</a></li>
                                    <li><a class="dropdown-item query-example" href="#">params.userId:* AND headers.User-Agent:"Chrome"</a></li>
                                    <li><a class="dropdown-item query-example" href="#">additionalData.level:"ERROR" OR additionalData.level:"FATAL"</a></li>
                                    <li><a class="dropdown-item query-example" href="#">headers.*:"localhost" AND method:"POST"</a></li>
                                    <li><a class="dropdown-item query-example" href="#">NOT headers.Authorization:* AND environment:"PROD"</a></li>
                                </ul>
                            </div>
                            <small class="text-muted">Use Splunk-like syntax to search headers, params, and additional data. Supports AND, OR, NOT operators.</small>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filter
                            </button>
                            <a href="/exceptions" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Exception Records</h5>
                <span class="badge bg-info" th:text="${exceptions.totalElements} + ' total exceptions'">0 total exceptions</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Timestamp</th>
                                <th>Exception Type</th>
                                <th>Message</th>
                                <th>Project</th>
                                <th>Service</th>
                                <th>Environment</th>
                                <th>Component</th>
                                <th>Method</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="exception : ${exceptions.content}">
                                <td>
                                    <small th:text="${#temporals.format(exception.timestamp, 'MM/dd HH:mm')}" 
                                           th:title="${#temporals.format(exception.timestamp, 'yyyy-MM-dd HH:mm:ss')}">01/01 12:00</small>
                                </td>
                                <td>
                                    <span class="badge bg-danger" th:text="${exception.exceptionType}">
                                        ExceptionType
                                    </span>
                                </td>
                                <td th:text="${#strings.abbreviate(exception.message, 60)}" 
                                    th:title="${exception.message}">
                                    Exception message...
                                </td>
                                <td>
                                    <span class="badge bg-primary" th:text="${exception.projectName ?: 'N/A'}">
                                        ProjectName
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-warning" th:text="${exception.serviceName ?: 'N/A'}">
                                        ServiceName
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-success" th:text="${exception.environment ?: 'N/A'}">
                                        Environment
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info" th:text="${exception.componentName ?: 'N/A'}">
                                        ComponentName
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary" th:text="${exception.method ?: 'N/A'}">
                                        GET
                                    </span>
                                </td>
                                <td>
                                    <a th:href="@{/exceptions/{id}(id=${exception.id})}" 
                                       class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-eye"></i> Details
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Exception pagination" th:if="${exceptions.totalPages > 1}">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" th:classappend="${!exceptions.hasPrevious()} ? 'disabled'">
                            <a class="page-link" th:href="@{/exceptions(page=${currentPage - 1}, projectName=${projectName}, exceptionType=${exceptionType}, environment=${environment}, componentName=${componentName}, serviceName=${serviceName}, method=${method}, advancedQuery=${advancedQuery}, timeRange=${selectedTimeRange}, customStartDate=${customStartDate}, customEndDate=${customEndDate})}">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        </li>
                        
                        <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, exceptions.totalPages - 1)}"
                            th:classappend="${pageNum == currentPage} ? 'active'"
                            th:if="${pageNum >= (currentPage - 2) and pageNum <= (currentPage + 2)}">
                            <a class="page-link" th:href="@{/exceptions(page=${pageNum}, projectName=${projectName}, exceptionType=${exceptionType}, environment=${environment}, componentName=${componentName}, serviceName=${serviceName}, method=${method}, advancedQuery=${advancedQuery}, timeRange=${selectedTimeRange}, customStartDate=${customStartDate}, customEndDate=${customEndDate})}"
                               th:text="${pageNum + 1}">1</a>
                        </li>
                        
                        <li class="page-item" th:classappend="${!exceptions.hasNext()} ? 'disabled'">
                            <a class="page-link" th:href="@{/exceptions(page=${currentPage + 1}, projectName=${projectName}, exceptionType=${exceptionType}, environment=${environment}, componentName=${componentName}, serviceName=${serviceName}, method=${method}, advancedQuery=${advancedQuery}, timeRange=${selectedTimeRange}, customStartDate=${customStartDate}, customEndDate=${customEndDate})}">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Custom Date Range Modal -->
    <div class="modal fade" id="customDateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Custom Date Range</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="customDateForm">
                        <div class="mb-3">
                            <label for="customStartDate" class="form-label">Start Date</label>
                            <input type="datetime-local" class="form-control" id="customStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="customEndDate" class="form-label">End Date</label>
                            <input type="datetime-local" class="form-control" id="customEndDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyCustomDateRange()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Query Help Modal -->
    <div class="modal fade" id="queryHelpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Advanced Query Syntax Help</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Query Syntax</h6>
                    <p>Use Splunk/OpenSearch-like syntax to filter exceptions based on headers, parameters, and additional data.</p>
                    
                    <h6>Basic Syntax</h6>
                    <ul>
                        <li><code>field:value</code> - Exact match</li>
                        <li><code>field:"value with spaces"</code> - Use quotes for values with spaces</li>
                        <li><code>field:*</code> - Field exists (any value)</li>
                        <li><code>field:val*</code> - Starts with "val"</li>
                        <li><code>field:*val</code> - Ends with "val"</li>
                        <li><code>field:*val*</code> - Contains "val"</li>
                    </ul>
                    
                    <h6>Field Prefixes</h6>
                    <ul>
                        <li><code>headers.</code> - Search in request headers</li>
                        <li><code>params.</code> - Search in request parameters</li>
                        <li><code>additionalData.</code> - Search in additional data</li>
                        <li>No prefix - Search in standard fields (exceptionType, message, etc.)</li>
                    </ul>
                    
                    <h6>Operators</h6>
                    <ul>
                        <li><code>AND</code> - Both conditions must match</li>
                        <li><code>OR</code> - Either condition must match</li>
                        <li><code>NOT</code> - Exclude matches</li>
                        <li>Parentheses <code>()</code> - Group conditions</li>
                    </ul>
                    
                    <h6>Examples</h6>
                    <div class="bg-light p-2 mb-2">
                        <code>headers.User-Agent:"Chrome"</code><br>
                        <small>Find exceptions where User-Agent header contains "Chrome"</small>
                    </div>
                    <div class="bg-light p-2 mb-2">
                        <code>params.userId:123 AND headers.Authorization:*</code><br>
                        <small>Find exceptions with userId=123 and any Authorization header</small>
                    </div>
                    <div class="bg-light p-2 mb-2">
                        <code>(headers.Host:"localhost" OR headers.Host:"127.0.0.1") AND method:"POST"</code><br>
                        <small>Find POST requests to localhost or 127.0.0.1</small>
                    </div>
                    <div class="bg-light p-2 mb-2">
                        <code>NOT headers.Authorization:* AND environment:"PROD"</code><br>
                        <small>Find production exceptions without Authorization header</small>
                    </div>
                    <div class="bg-light p-2 mb-2">
                        <code>additionalData.level:"ERROR" OR additionalData.level:"FATAL"</code><br>
                        <small>Find exceptions with ERROR or FATAL level in additional data</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedRange = '';
        
        function selectTimeRange(range) {
            // Update UI - remove active class from all buttons, add to selected
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');
            
            // Store selected range
            selectedRange = range;
            document.getElementById('selectedTimeRange').value = range;
            
            // Clear custom date inputs for predefined ranges
            document.getElementById('customStartDateInput').value = '';
            document.getElementById('customEndDateInput').value = '';
        }
        
        function applyCustomDateRange() {
            const startDate = document.getElementById('customStartDate').value;
            const endDate = document.getElementById('customEndDate').value;
            
            if (startDate && endDate) {
                const startISO = new Date(startDate).toISOString();
                const endISO = new Date(endDate).toISOString();
                
                // Set form values
                document.getElementById('selectedTimeRange').value = 'custom';
                document.getElementById('customStartDateInput').value = startISO;
                document.getElementById('customEndDateInput').value = endISO;
                
                // Update UI
                document.querySelectorAll('.btn-group .btn').forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                });
                
                // Close modal and submit form
                const modal = bootstrap.Modal.getInstance(document.getElementById('customDateModal'));
                modal.hide();
                document.getElementById('timeRangeForm').submit();
            }
        }
        
        // Set default values for custom date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            document.getElementById('customEndDate').value = now.toISOString().slice(0, 16);
            document.getElementById('customStartDate').value = yesterday.toISOString().slice(0, 16);
            
            // Query example click handler
            document.querySelectorAll('.query-example').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.getElementById('advancedQuery').value = this.textContent;
                });
            });
        });
    </script>
</body>
</html>